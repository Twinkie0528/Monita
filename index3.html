<!DOCTYPE html>
<html lang="mn" class="js">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UNIMAK - Secret Santa 2025</title>
    <link href="https://fonts.googleapis.com/css?family=Manrope:300,400,700&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. NORMALIZE & BASE
           ========================================= */
        *, *::after, *::before { box-sizing: border-box; }
        
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            background: radial-gradient(ellipse at bottom, #06402B 0%, #146B3A 100%);
            color: #F8B229;
            font-family: 'Manrope', sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        #snow-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 1; 
        }

        /* =========================================
           2. HEADER
           ========================================= */
        .site-header {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            z-index: 100;
            pointer-events: none; 
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            pointer-events: auto;
        }

        .header-title {
            font-weight: 700;
            font-size: 1.8rem;
            color: #F8B229; 
            margin: 0;
            line-height: 1;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header-right-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            pointer-events: auto;
        }

        .header-brand {
            font-weight: 700;
            font-size: 1.2rem;
            color: #F8B229; 
            text-transform: uppercase;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            text-align: right;
        }

        .admin-trigger {
            background: none;
            border: none;
            color: rgba(248, 178, 41, 0.6);
            font-size: 0.8rem;
            cursor: pointer;
            padding: 5px 10px;
            text-transform: uppercase;
            box-shadow: none;
            margin-top: 5px;
        }
        .admin-trigger:hover {
            color: #fff;
            text-decoration: underline;
        }

        /* =========================================
           3. CENTER MESSAGE
           ========================================= */
        .center-message-container {
            position: absolute;
            top: 12vh; 
            width: 100%;
            text-align: center;
            z-index: 10;
            pointer-events: none;
            padding: 0 20px;
        }

        .Strategy {
            font-size: 1.2rem;
            color: #F8B229;
            text-transform: uppercase;
            letter-spacing: 3px;
            opacity: 0.9;
        }

        .status-text {
            font-size: 3rem;
            font-weight: 700;
            color: #F8B229;
            text-transform: uppercase;
            text-shadow: 0 4px 15px rgba(0,0,0,0.4);
            margin: 10px 0;
            line-height: 1.1;
        }
        
        .current-user-display {
            font-size: 1.2rem;
            color: #fff;
            background: rgba(0,0,0,0.3);
            padding: 8px 25px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* =========================================
           4. UI CONTROLS
           ========================================= */
        .ui-controls {
            position: absolute;
            bottom: 5vh;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            display: flex;
            gap: 15px;
            align-items: center;
            width: 90%;
            justify-content: center;
        }

        button {
            background: #F8B229;
            color: #06402B;
            border: none;
            padding: 1em 2em;
            font-family: 'Manrope', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 50px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            text-transform: uppercase;
            white-space: nowrap;
        }

        button:active {
            transform: scale(0.95);
        }

        button:disabled {
            background: #ccc;
            color: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: rgba(0,0,0,0.2);
            border: 2px solid #F8B229;
            color: #F8B229;
            backdrop-filter: blur(4px);
        }

        /* =========================================
           5. 3D SCENE & CUBES
           ========================================= */
        .calendar-wrap {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            perspective: 2000px; 
            z-index: 5; 
            overflow: hidden;
        }

        .calendar {
            position: relative;
            width: 0; height: 0;
            transform-style: preserve-3d;
            transition: transform 1.5s cubic-bezier(0.19, 1, 0.22, 1);
        }

        /* DEFAULT DESKTOP CUBE SIZES */
        :root {
            --cube-size: 5vw;
            --cube-half: 2.5vw;
        }

        .cube {
            position: absolute;
            width: var(--cube-size); 
            height: var(--cube-size); 
            margin-top: calc(var(--cube-half) * -1); 
            margin-left: calc(var(--cube-half) * -1);
            transform-style: preserve-3d;
            transition: transform 1s, opacity 0.5s;
        }

        .cube__side {
            position: absolute;
            width: 100%; height: 100%;
            border: 1px solid rgba(255,255,255,0.5);
            background-color: #fff; 
            background-repeat: no-repeat;
            background-position: center center;
            background-size: cover; 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            backface-visibility: hidden; /* Performance boost */
        }

        /* Cube faces using CSS Variables for easy resizing */
        .cube__side--front  { transform: translateZ(var(--cube-half)); }
        .cube__side--back   { transform: rotateY(180deg) translateZ(var(--cube-half)); }
        .cube__side--right  { transform: rotateY(90deg) translateZ(var(--cube-half)); }
        .cube__side--left   { transform: rotateY(-90deg) translateZ(var(--cube-half)); }
        .cube__side--top    { transform: rotateX(90deg) translateZ(var(--cube-half)); }
        .cube__side--bottom { transform: rotateX(-90deg) translateZ(var(--cube-half)); }

        /* Images Logic */
        .cube:nth-child(5n+1) .cube__side { background-image: url('img/c1.png'); background-color: #06402B; }
        .cube:nth-child(5n+2) .cube__side { background-image: url('img/c2.png'); background-color: #06402B; } 
        .cube:nth-child(5n+3) .cube__side { background-image: url('img/c3.png'); background-color: #ffffff; }
        .cube:nth-child(5n+4) .cube__side { background-image: url('img/c4.png'); background-color: #F8B229; }
        .cube:nth-child(5n+5) .cube__side { background-image: url('img/c5.png'); background-color: #06402B; }

        .cube__number {
            position: absolute;
            width: 140%; 
            left: -20%;
            height: auto;
            padding: 4px 0;
            top: 50%;
            transform: translateY(-50%) translateZ(calc(var(--cube-half) + 2px));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.7vw; 
            color: #06402B;
            background: #fff;
            text-align: center;
            z-index: 10;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        .cube.is-selected .cube__side {
            box-shadow: 0 0 50px rgba(248, 178, 41, 0.8);
            border-color: #F8B229;
            background-color: #F8B229 !important;
        }
        .cube.is-selected .cube__number {
            color: #06402B; 
            background: #F8B229;
            font-size: 1vw;
            z-index: 100;
        }
        
        .cube.is-eliminated {
            opacity: 0.1;
            filter: grayscale(100%);
            transform: scale(0.1) !important;
            pointer-events: none;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        /* =========================================
           6. MODALS
           ========================================= */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(6, 64, 43, 0.95);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            width: 90%;
            max-width: 800px; 
            max-height: 85vh; 
            color: #06402B;
            border: 4px solid #F8B229;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .modal-content h2 { margin-top: 0; color: #06402B;}

        .search-input, .admin-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-size: 1rem;
            font-family: 'Manrope', sans-serif;
            outline: none;
        }
        .search-input:focus { border-color: #06402B; }

        .login-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin: 10px 0;
            overflow-y: auto;
            padding-right: 5px;
            flex-grow: 1;
        }
        
        .login-btn {
            padding: 12px 5px;
            font-size: 0.9rem;
            background: #f4f4f4;
            color: #333;
            box-shadow: none;
            border-radius: 8px;
            border: 1px solid #ddd;
            width: 100%;
        }
        .login-btn:hover {
            background: #06402B;
            color: #fff;
            border-color: #06402B;
        }
        .login-btn.done {
            opacity: 0.5;
            text-decoration: line-through;
            background: #ddd;
            pointer-events: none;
        }

        .result-name {
            font-size: 3rem;
            margin: 30px 0;
            color: #06402B;
            font-weight: 800;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 2px 2px 0px #F8B229;
            word-break: break-word;
            line-height: 1.1;
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .rules-text {
            text-align: left;
            font-size: 0.95rem;
            line-height: 1.6;
            margin-bottom: 20px;
            overflow-y: auto;
            max-height: 50vh;
        }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #06402B; z-index: 5000;
            display: flex; justify-content: center; align-items: center;
            color: #F8B229; font-size: 1.5rem; font-weight: bold;
        }

        /* =========================================
           7. MOBILE RESPONSIVE FIXES
           ========================================= */
        @media (max-width: 768px) {
            /* Fix Cube Size on Mobile - Make them BIGGER relatively */
            :root {
                --cube-size: 14vw; /* Much larger relative to screen width */
                --cube-half: 7vw;
            }

            .site-header {
                padding: 15px 20px;
                flex-direction: row; /* Keep row but minimize */
                align-items: center;
            }
            
            .header-title {
                font-size: 1.1rem; /* Smaller title */
                text-align: left;
            }
            
            .header-brand {
                font-size: 0.8rem; /* Smaller brand */
            }

            .center-message-container {
                top: 15vh;
            }
            
            .Strategy {
                font-size: 0.9rem;
            }
            
            .status-text {
                font-size: 2rem; /* Smaller main text */
            }

            .cube__number {
                font-size: 3.5vw; /* Make text readable on mobile cube */
                transform: translateY(-50%) translateZ(calc(var(--cube-half) + 1px));
            }

            .cube.is-selected .cube__number {
                font-size: 4vw;
            }

            /* UI Controls Fix */
            .ui-controls {
                flex-wrap: wrap; /* Allow wrapping if needed */
                gap: 10px;
                bottom: 8vh;
                width: 95%;
            }

            button {
                padding: 0.8em 1.5em; /* Smaller padding */
                font-size: 0.9rem;
                flex: 1 1 auto; /* Grow to fill space */
                min-width: 100px;
            }
            
            /* Specific fix for 'Change User' button which is long */
            #changeUserBtn {
                flex-basis: 100%; /* Make it take full row on very small screens if needed, or just let it flow */
                order: 3; /* Put it at the bottom on mobile if we want, or keep logic */
            }

            .login-grid {
                grid-template-columns: repeat(2, 1fr); /* 2 columns on mobile */
            }
            
            .result-name {
                font-size: 2rem;
            }
            
            .modal-content {
                padding: 20px;
            }
        }
        
        /* Small phones fix */
        @media (max-width: 380px) {
            :root {
                --cube-size: 16vw; 
                --cube-half: 8vw;
            }
            .status-text { font-size: 1.8rem; }
            .header-title { font-size: 1rem; }
            .header-brand { font-size: 0.7rem; }
            .ui-controls { bottom: 4vh; }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        –£–Ω—à–∏–∂ –±–∞–π–Ω–∞...
    </div>

    <canvas id="snow-canvas"></canvas>

    <header class="site-header">
        <div class="header-left">
            <h1 class="header-title">Secret Santa<br>2025</h1>
        </div>
        <div class="header-right-wrapper">
            <div class="header-brand">UNIMAK<br>MARKETERS</div>
            <button class="admin-trigger" onclick="showAdmin()">Admin</button>
        </div>
    </header>

    <div class="center-message-container">
        <div class="Strategy">2025 NEW YEAR</div>
        <div class="status-text" id="mainStatus">SECRET SANTA</div>
        <div class="current-user-display" id="currentUserDisplay" style="display:none;"></div>
    </div>

    <div class="calendar-wrap">
        <div class="calendar" id="grid">
            <!-- Cubes generated here -->
        </div>
    </div>

    <!-- UI Buttons -->
    <div class="ui-controls">
        <button id="startBtn" onclick="startLottery()" disabled>–≠–†–ì“Æ“Æ–õ–≠–•</button>
        <button class="btn-secondary" onclick="showRules()">–î“Ø—Ä—ç–º</button>
        <button id="changeUserBtn" class="btn-secondary" onclick="showLogin()">–•—ç—Ä—ç–≥–ª—ç–≥—á —Å–æ–ª–∏—Ö</button>
    </div>

    <!-- LOGIN MODAL -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <h2>üëã –°–∞–π–Ω –±–∞–π–Ω–∞ —É—É?</h2>
            <p>–¢–∞ ”©”©—Ä–∏–π–Ω –Ω—ç—Ä–∏–π–≥ –±–∏—á–∏–∂ —Ö–∞–π–Ω–∞ —É—É.</p>
            
            <input type="text" id="nameSearch" class="search-input" placeholder="–ù—ç—Ä –±–∏—á–∏—Ö..." onkeyup="filterNames()">

            <div class="login-grid" id="loginList">
                <!-- JS populates this -->
            </div>
        </div>
    </div>

    <!-- RULES MODAL -->
    <div id="rulesModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <h3>üìú –¢–æ–≥–ª–æ–æ–º—ã–Ω –¥“Ø—Ä—ç–º</h3>
            <div class="rules-text">
                <ol>
                    <li><strong>–•—É–≥–∞—Ü–∞–∞:</strong> <ul> <li> –≠—Ö–Ω–∏–π –±—ç–ª—ç–≥ : 12 —Å–∞—Ä—ã–Ω 12</li>
                    <li>–•–æ—ë—Ä –¥–∞—Ö—å –±—ç–ª—ç–≥ : 12 —Å–∞—Ä—ã–Ω 19</li>
                    <li>–ì—É—Ä–∞–≤ –¥–∞—Ö—å –±—ç–ª—ç–≥ : 12 —Å–∞—Ä—ã–Ω 26</li>
                    </ul>
                    <li><strong>–ë—ç–ª–≥–∏–π–Ω —Ç”©—Å”©–≤, —Ç”©—Ä”©–ª</strong>
                        <ul>
                            <li>1. –•–∞–º–≥–∏–π–Ω –±“Ø—Ç—ç—ç–ª—á –¥—É–ª–∞–∞—Ö–∞–Ω –±—ç–ª—ç–≥ 20'000‚ÇÆ </li>
                            <li>2. ”®”©—Ä–∏–π–≥”©”© –∏–ª—ç—Ä—Ö–∏–π–ª—ç—Ö –±—ç–ª—ç–≥ , –∑–∞—Ö–∏–∞ 20'000‚ÇÆ</li>
                            <li>3. –ß”©–ª”©”©—Ç—ç–π 50'000‚ÇÆ ü§´</li>
                        </ul>
                    </li>
                    <li><strong>–•“Ø–π—Å–∏–π–Ω –∑–æ—Ö–∏—Ü—É—É–ª–∞–ª—Ç (–®–∏–Ω—ç—á–ª—ç–≥–¥—Å—ç–Ω):</strong>
                        <ul>
                            <li>–≠–º—ç–≥—Ç—ç–π—á“Ø“Ø–¥ –±–æ–ª–æ–º–∂—Ç–æ–π –±–æ–ª —ç—Ä—ç–≥—Ç—ç–π —Ö“Ø–Ω —Å—É–≥–∞–ª–Ω–∞ (–ì—ç—Ö–¥—ç—ç —ç—Ä—ç–≥—Ç—ç–π—á“Ø“Ø–¥ –¥—É—É—Å—Å–∞–Ω –±–æ–ª —ç–º—ç–≥—Ç—ç–π —Ö“Ø–Ω —Å—É–≥–∞–ª–∞—Ö –±–æ–ª–æ–º–∂—Ç–æ–π).</li>
                            <li>–≠—Ä—ç–≥—Ç—ç–π—á“Ø“Ø–¥ —ç—Ö–ª—ç—ç–¥ —ç–º—ç–≥—Ç—ç–π —Ö“Ø–Ω —Å—É–≥–∞–ª–Ω–∞ (—ç–º—ç–≥—Ç—ç–π—á“Ø“Ø–¥ –¥—É—É—Å—Å–∞–Ω –±–æ–ª —ç—Ä—ç–≥—Ç—ç–π —Ö“Ø–Ω —Å—É–≥–∞–ª–∞—Ö –±–æ–ª–æ–º–∂—Ç–æ–π).</li>
                        </ul>
                    </li>
                </ol>
            </div>
            <button onclick="closeRules()">–û–π–ª–≥–æ–ª–æ–æ</button>
        </div>
    </div>

    <!-- ADMIN MODAL -->
    <div id="adminModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <h3>üîê Admin Access</h3>
            <p>”®–≥”©–≥–¥–ª–∏–π–≥ —É—Å—Ç–≥–∞—Ö—ã–Ω —Ç—É–ª–¥ –Ω—É—É—Ü –∫–æ–¥ –æ—Ä—É—É–ª–Ω–∞ —É—É.</p>
            <input type="password" id="adminCode" class="admin-input" placeholder="–ù—É—É—Ü –∫–æ–¥...">
            <div id="adminControls" style="display:none; margin-top:15px;">
                <button onclick="resetData()" style="background: #BB2528; color: white;">RESET ALL DATA</button>
            </div>
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="checkAdminCode()">–ù—ç–≤—Ç—Ä—ç—Ö</button>
                <button class="btn-secondary" onclick="closeAdmin()" style="border-color:#ccc; color:#666;">–•–∞–∞—Ö</button>
            </div>
        </div>
    </div>

    <!-- RESULT MODAL -->
    <div id="resultModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px; height: auto;">
            <h3>üéÅ –¢–∞–Ω—ã —Å—É–≥–∞–ª—Å–∞–Ω —Ö“Ø–Ω:</h3>
            <div class="result-name" id="resultNameDisplay">NAME</div>
            <p>–ë–∞—è—Ä —Ö“Ø—Ä–≥—ç–µ! –≠–Ω—ç —Ö“Ø–Ω–∏–π "Secret Santa" –±–æ–ª —Ç–∞ —é–º.</p>
            <p style="font-size: 0.8rem; color: #666; margin-top: 20px;">–ù—É—É—Ü–∞–∞ —Å–∞–π–Ω —Ö–∞–¥–≥–∞–ª–∞–∞—Ä–∞–π üòâ</p>
            <button onclick="closeResult()">–û–π–ª–≥–æ–ª–æ–æ</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCD4okPcyMomZmgAQzHQK7fvzAXZYLKBHY",
            authDomain: "unimak-monita.firebaseapp.com",
            projectId: "unimak-monita",
            storageBucket: "unimak-monita.firebasestorage.app",
            messagingSenderId: "303739930942",
            appId: "1:303739930942:web:8ecf90e5f660aefed6446f",
            measurementId: "G-7937VYXL3C"
        };

        // Initialize Firebase
        let db;
        let analytics;
        let auth;
        let authUser = null;

        try {
            const app = initializeApp(firebaseConfig);
            analytics = getAnalytics(app);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase initialized with Auth & Analytics");
        } catch (e) {
            console.error("Firebase init error:", e);
            if(firebaseConfig.apiKey.includes("–≠–ù–î_–¢–ê–ù–´")) {
                alert("Firebase —Ç–æ—Ö–∏—Ä–≥–æ–æ —Ö–∏–π–≥–¥—ç—ç–≥“Ø–π –±–∞–π–Ω–∞! –≠—Ö –∫–æ–¥ —Ä—É—É –æ—Ä–∂ firebaseConfig —Ö—ç—Å–≥–∏–π–≥ —à–∏–Ω—ç—á–∏–ª–Ω—ç “Ø“Ø.");
            }
        }

        const COLLECTION_NAME = "secretsanta2025";
        
        // --- GLOBAL STATE ---
        let matchesMap = {}; // Local copy of DB data
        let isDataLoaded = false;
        let currentUser = null;
        let currentUserGender = null;
        let cubes = [];
        let isRunning = false;
        
        const ADMIN_CODE = "2025";
        
        // Participants Data
        const participantsData = [
        { name: "–¢.–¶—ç–≤—ç–≥–Ω—è–º", gender: "male" },
        { name: "–ê.–†–µ–Ω—á–∏–Ω–¥–æ—Ä–∂", gender: "male" },
        { name: "–ú.–ê—Ä–∏—É–Ω–º”©–Ω—Ö", gender: "female" },
        { name: "–ë.–≠–Ω—Ö–∑—É–ª", gender: "female" },
        { name: "–ì.–ê–Ω—É", gender: "female" },
        { name: "–ë.–ê–Ω–∞—Ä", gender: "male" },
        { name: "–≠.–≠–Ω—Ö—Ü–∞—Ü—Ä–∞–ª", gender: "female" },
        { name: "–•.–û—é—É–Ω–¥—ç–ª–≥—ç—Ä", gender: "female" },
        { name: "–¶.–û—é—É–¥–∞—Ä—å", gender: "female" },
        { name: "–ù.–≠–Ω—Ö-”®–ª–∑–∏–π", gender: "male" },
        { name: "–•.–¢”©–≥”©–ª–¥”©—Ä", gender: "male" },
        { name: "–ë.–≠—Ä–¥—ç–Ω—ç–±—É–ª–≥–∞–Ω", gender: "male" },
        { name: "–≠.–ê—á–ª–∞–ª—Ç–≠—Ä–¥—ç–Ω—ç", gender: "male" },
        { name: "–Å.–ò—á–∏–Ω–Ω–æ—Ä–æ–≤", gender: "female" },
        { name: "–ì.–¢—ç–≤—Ç—ç–Ω–≥—ç—Ä", gender: "male" },
        { name: "–ê.–î”©–ª–≥”©”©–Ω", gender: "male" },
        { name: "–ë.–ó–æ–ª–∑–∞—è–∞", gender: "female" },
        { name: "–ú.–î–∞—è–Ω–±—É–¥", gender: "male" },
        { name: "–ë.–ß–∏–Ω—Å–∞–Ω–∞–∞", gender: "male" },
        { name: "–ú.–ó–æ–ª–∑–∞—è–∞", gender: "female" },
        { name: "–ê.–≠–Ω—Ö—á–∏–º—ç–≥", gender: "female" },
        { name: "–°.–≠–Ω—Ö-–û—Ä—á–ª–æ–Ω", gender: "male" },
        { name: "–ê.–ë–∞—Ç—á–∏–º—ç–≥", gender: "female" },
        { name: "–ì.–ñ–∞—Ä–≥–∞–ª–º–∞–∞", gender: "female" },
        { name: "–ë.–ù–∞—Ä–∞–Ω—Ü—ç—Ü—ç–≥", gender: "female" },
        { name: "–ë.–ú”©—Ä”©–Ω", gender: "male" },
        { name: "–ù.–¶—ç—Ü—ç–≥–¥—ç–ª–≥—ç—Ä", gender: "female" },
        { name: "–î.–ú”©–Ω—Ö–±–∞—Ç", gender: "male" },
        { name: "–≠.–ú”©–Ω—Ö—Ü—ç–ª–º“Ø“Ø–Ω", gender: "female" },
        { name: "–ü.–¶—ç—Ü—ç–≥–∂–∞—Ä–≥–∞–ª", gender: "female" },
        { name: "–°.–°–∞—Ä–∞–Ω", gender: "female" },
        { name: "–ë.”®–ª–∑–∏–π–±–∞—è—Ä", gender: "female" },
        { name: "–•.–ë–∏—à—Ä—ç–ª", gender: "male" },
        { name: "–ë.–î–æ–ª–≥–æ—Ä–º–∞–∞", gender: "female" },
        { name: "–ë.–ú”©–Ω—Ö—Ü–∞—Ü—Ä–∞–ª", gender: "female" },
        { name: "–ì.–ë–æ–ª–æ—Ä-–≠—Ä–¥—ç–Ω—ç", gender: "female" },
        { name: "–ú.–£—è–Ω–≥–∞", gender: "female" },
        { name: "–ì.–¢”©—Ä–±–∞—Ç", gender: "male" },
        { name: "–ë.–û—Ä—Ö–æ–Ω—Ç—É—É–ª", gender: "female" },
        { name: "–û.–£—Ä–∞–Ω–≥–æ–æ", gender: "female" },
        { name: "–¶.–°–æ–¥–Ω–æ–º—Ü—ç—Ä—ç–Ω", gender: "male" },
        { name: "–°.–î–∞–≤–∞–∞—Å“Ø—Ä—ç–Ω", gender: "female" },
        { name: "–ù.–ê–Ω–∞—Ä", gender: "male" },
        { name: "–ú.–ù–∞—Ä–∞–Ω—Ü–∞—Ü—Ä–∞–ª", gender: "female" },
        { name: "–û.–ù–∞–º—É—É–Ω–∑–∞—è–∞", gender: "female" },
        { name: "–•.–¢”©–≥”©–ª–¥”©—Ä", gender: "male" },
        { name: "–õ.–ú—è–≥–º–∞—Ä—Å“Ø—Ä—ç–Ω", gender: "male" },
        { name: "–ê.–ê–π–≥–µ—Ä–∏–º", gender: "female" },
        { name: "–ê.–ë–æ–ª–æ—Ä—Ç—É–ª–≥–∞", gender: "male" },
        { name: "–ì.–ê–º–∞—Ä—Å–∞–Ω–∞–∞", gender: "male" },
        { name: "–î.–≠–≥—à–∏–≥–ª—ç–Ω", gender: "female" },
        { name: "–û.–ë–∏–ª–∏–≥—Å–∞–π—Ö–∞–Ω", gender: "male" },
        { name: "–ú.–û—Ä–≥–∏–ª", gender: "male" },
        { name: "–ê.–ñ–∞–≤—Ö–ª–∞–Ω", gender: "male" },
        { name: "–ë.–î“Ø“Ø—Ä—ç–Ω—Ç—É—è–∞", gender: "female" },
        { name: "–û.–ú”©–Ω—Ö—Å–∞–π—Ö–∞–Ω", gender: "male" },
        { name: "–≠.–ë—É–¥–∂–∞–≤", gender: "male" },
        { name: "–î.–ú”©–Ω–≥”©–Ω—Ü—ç—Ü—ç–≥", gender: "female" },
        { name: "–ê.–•–∞–Ω—Ç”©—Ä", gender: "male" },
        { name: "–ë.“Æ—Ä–∂–∏–Ω–±–∞—è—Å–∞—Ö", gender: "female" },
        { name: "–≠.–¶—ç–≤—ç—ç–Ω–¥–æ—Ä–∂", gender: "male" },
        { name: "–ê.–ú”©–Ω—Ö—Ö“Ø—Å–ª—ç–Ω", gender: "female" }
        ];


        participantsData.sort((a, b) => a.name.localeCompare(b.name));

        // ================= INITIALIZATION =================
        window.onload = () => {
            initSnow();
            animateSnow();
            initAppAuth(); // Start Auth Flow
        };

        // --- Auth & Listener Setup ---
        function initAppAuth() {
            if (!auth) return;

            signInAnonymously(auth)
                .then(() => {
                    console.log("Signed in anonymously");
                })
                .catch((error) => {
                    console.error("Auth Error:", error);
                    if (error.code === 'auth/configuration-not-found' || error.code === 'auth/admin-restricted-operation' || error.code === 'auth/operation-not-allowed') {
                        alert("–ê–õ–î–ê–ê: Authentication –∏–¥—ç–≤—Ö–∂—ç—ç–≥“Ø–π –±–∞–π–Ω–∞!\n\nFirebase Console -> Build -> Authentication -> Get Started -> Anonymous-–≥ Enable —Ö–∏–π–Ω—ç “Ø“Ø.");
                    } else {
                        alert("–•–æ–ª–±–æ–ª—Ç—ã–Ω –∞–ª–¥–∞–∞: " + error.message);
                    }
                });

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    authUser = user;
                    startDataListener(); 
                } else {
                    authUser = null;
                }
            });
        }

        // --- Realtime Listener ---
        function startDataListener() {
            if (!authUser) return;

            try {
                onSnapshot(collection(db, COLLECTION_NAME), (snapshot) => {
                    matchesMap = {};
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        matchesMap[doc.id] = data.target; 
                    });
                    
                    isDataLoaded = true;
                    document.getElementById('loadingOverlay').style.display = 'none';
                    
                    if(document.getElementById('loginModal').classList.contains('show')) {
                        renderLoginList();
                    }
                }, (error) => {
                    console.error("Snapshot Error:", error);
                    if (error.code === 'permission-denied') {
                       alert("–ê–ù–•–ê–ê–†: ”®–≥”©–≥–¥–ª–∏–π–Ω —Å–∞–Ω –¶–û–û–ñ–¢–û–ô –±–∞–π–Ω–∞!\n\nFirebase Console -> Firestore Database -> Rules —Ö—ç—Å—ç–≥—Ç –æ—Ä–∂ –¥“Ø—Ä–º—ç—ç –∑–∞—Å–Ω–∞ —É—É.\n(Production mode —Å–æ–Ω–≥–æ—Å–æ–Ω –±–æ–ª –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä —Ü–æ–æ–∂–ª–æ–≥–¥–¥–æ–≥)");
                    } else if (error.code === 'not-found' || error.message.includes("not-found")) {
                        alert("”®–≥”©–≥–¥–ª–∏–π–Ω —Å–∞–Ω –æ–ª–¥–æ—Ö–≥“Ø–π –±–∞–π–Ω–∞! (Database not found)\n\n–¢–∞ Firebase Console –¥—ç—ç—Ä—ç—ç '(default)' –Ω—ç—Ä—Ç—ç–π database “Ø“Ø—Å–≥—ç—Å—ç–Ω —ç—Å—ç—Ö—ç—ç —à–∞–ª–≥–∞–∞—Ä–∞–π.\n–•—ç—Ä—ç–≤ –¥”©–Ω–≥”©–∂ “Ø“Ø—Å–≥—ç—Å—ç–Ω –±–æ–ª 1-2 –º–∏–Ω—É—Ç —Ö“Ø–ª—ç—ç–≥—ç—ç–¥ refresh —Ö–∏–π–Ω—ç “Ø“Ø.");
                    } else {
                        alert("–ê–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞: " + error.message);
                    }
                });
            } catch (e) {
                console.error("Listener error:", e);
            }
        }

        // ================= ADMIN & RESET =================
        window.showAdmin = function() {
            document.getElementById('adminModal').classList.add('show');
            document.getElementById('adminCode').value = '';
            document.getElementById('adminControls').style.display = 'none';
        }

        window.closeAdmin = function() {
            document.getElementById('adminModal').classList.remove('show');
        }

        window.checkAdminCode = function() {
            const input = document.getElementById('adminCode').value;
            if (input === ADMIN_CODE) {
                document.getElementById('adminControls').style.display = 'block';
            } else {
                alert("–ù—É—É—Ü –∫–æ–¥ –±—É—Ä—É—É –±–∞–π–Ω–∞!");
            }
        }

        window.resetData = async function() {
            if (!authUser) { alert("–•–æ–ª–±–æ–ª—Ç —Å–∞–ª—Å–∞–Ω –±–∞–π–Ω–∞."); return; }
            
            if(confirm("–ê–ù–•–ê–ê–†: –ë“Ø—Ö ”©–≥”©–≥–¥–ª–∏–π–≥ —É—Å—Ç–≥–∞—Ö —É—É? –≠–Ω—ç “Ø–π–ª–¥–ª–∏–π–≥ –±—É—Ü–∞–∞—Ö –±–æ–ª–æ–º–∂–≥“Ø–π!")) {
                const batch = writeBatch(db);
                const snapshot = await getDocs(collection(db, COLLECTION_NAME));
                snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                alert("–ë“Ø—Ö ”©–≥”©–≥–¥”©–ª —É—Å—Ç–≥–∞–≥–¥–ª–∞–∞.");
                location.reload();
            }
        }

        // ================= RULES =================
        window.showRules = function() {
            document.getElementById('rulesModal').classList.add('show');
        }
        window.closeRules = function() {
            document.getElementById('rulesModal').classList.remove('show');
        }

        // ================= LOGIN & SEARCH =================
        window.renderLoginList = function() {
            const listEl = document.getElementById('loginList');
            listEl.innerHTML = '';

            participantsData.forEach(p => {
                const btn = document.createElement('button');
                btn.className = 'login-btn';
                
                if (matchesMap[p.name]) {
                    btn.classList.add('done');
                    btn.innerHTML = `${p.name} <br><small>‚úÖ</small>`;
                } else {
                    btn.innerText = p.name;
                    btn.onclick = () => login(p.name, p.gender);
                }
                btn.style.display = 'none';
                listEl.appendChild(btn);
            });
        }

        window.filterNames = function() {
            const input = document.getElementById('nameSearch');
            const filter = input.value.toUpperCase();
            const list = document.getElementById('loginList');
            const buttons = list.getElementsByTagName('button');

            if (filter.length === 0) {
                for (let i = 0; i < buttons.length; i++) buttons[i].style.display = "none";
                return;
            }

            for (let i = 0; i < buttons.length; i++) {
                const txtValue = buttons[i].textContent || buttons[i].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    buttons[i].style.display = ""; 
                } else {
                    buttons[i].style.display = "none";
                }
            }
        }

        window.showLogin = function() {
            document.getElementById('loginModal').classList.add('show');
            document.getElementById('nameSearch').value = ''; 
            renderLoginList(); 
            
            document.getElementById('grid').innerHTML = '';
            document.getElementById('currentUserDisplay').style.display = 'none';
            document.getElementById('startBtn').disabled = true;
            document.getElementById('mainStatus').innerText = "SECRET SANTA";
        }

        window.login = function(name, gender) {
            currentUser = name;
            currentUserGender = gender;

            document.getElementById('loginModal').classList.remove('show');

            const userDisplay = document.getElementById('currentUserDisplay');
            userDisplay.innerText = currentUser;
            userDisplay.style.display = 'inline-block';

            if (matchesMap[currentUser]) {
                const target = matchesMap[currentUser];
                document.getElementById('resultNameDisplay').innerText = target;
                document.getElementById('resultModal').classList.add('show');
                alert(`–¢–∞ –∞–ª—å —Ö—ç–¥–∏–π–Ω —Å—É–≥–∞–ª–∞–∞–≥–∞–∞ —Ç–∞—Ç—Å–∞–Ω –±–∞–π–Ω–∞!`);
            } else {
                document.getElementById('startBtn').disabled = false;
                setupSceneForUser(currentUser);
            }
        }

        // ================= SCENE SETUP (OPTIMIZED LOGIC) =================
        function setupSceneForUser(user) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            cubes = [];
            grid.style.transform = "rotateY(0deg)";
            grid.style.animation = "none";

            // Get ALREADY TAKEN names
            const alreadyTakenNames = Object.values(matchesMap);

            // Filter out self and already taken
            let allCandidates = participantsData.filter(p => p.name !== user && !alreadyTakenNames.includes(p.name));
            let preferredCandidates = [];

            if (currentUserGender === 'female') {
                // STRATEGY: Females desperately need Males.
                // Try to find Males first.
                let maleCandidates = allCandidates.filter(p => p.gender === 'male');
                
                if (maleCandidates.length > 0) {
                    preferredCandidates = maleCandidates;
                } else {
                    // No males left. Must pick Female.
                    preferredCandidates = allCandidates;
                }
            } 
            else { // Male
                // STRATEGY: Males should leave the Male targets for the Females.
                // So Males should prioritize picking Females.
                let femaleCandidates = allCandidates.filter(p => p.gender === 'female');
                
                if (femaleCandidates.length > 0) {
                    preferredCandidates = femaleCandidates;
                } else {
                    // No females left. Must pick Male.
                    preferredCandidates = allCandidates;
                }
            }

            if (preferredCandidates.length === 0) {
                alert("–£—É—á–ª–∞–∞—Ä–∞–π, —Å—É–≥–∞–ª–∞—Ö —Ö“Ø–Ω “Ø–ª–¥—Å—ç–Ω–≥“Ø–π!");
                return;
            }

            preferredCandidates.sort(() => Math.random() - 0.5);

            // Responsive Range
            const isMobile = window.innerWidth < 600;
            const range = isMobile ? window.innerWidth * 0.8 : 800;

            preferredCandidates.forEach(p => {
                const el = document.createElement('div');
                el.className = 'cube';
                el.innerHTML = `
                    <div class="cube__side cube__side--front"></div>
                    <div class="cube__side cube__side--back"></div>
                    <div class="cube__side cube__side--right"></div>
                    <div class="cube__side cube__side--left"></div>
                    <div class="cube__side cube__side--top"></div>
                    <div class="cube__side cube__side--bottom"></div>
                    <div class="cube__number">${p.name}</div>
                `;

                const x = (Math.random() - 0.5) * range;
                const y = (Math.random() - 0.5) * range;
                const z = (Math.random() - 0.5) * range;
                
                const rX = Math.random() * 360;
                const rY = Math.random() * 360;

                el.style.transform = `translate3d(${x}px, ${y}px, ${z}px) rotateX(${rX}deg) rotateY(${rY}deg)`;

                grid.appendChild(el);
                cubes.push({ el, name: p.name, active: true });
            });
        }

        // ================= LOTTERY ANIMATION =================
        window.startLottery = function() {
            if (isRunning) return;
            if (!authUser) { alert("–•–æ–ª–±–æ–ª—Ç—ã–Ω –∞–ª–¥–∞–∞. –î–∞—Ö–∏–Ω –∞—á–∞–∞–ª–Ω–∞ —É—É."); return; }

            // --- SAFETY CHECK (RACE CONDITION) ---
            const currentTakenNames = Object.values(matchesMap);
            
            let removedCount = 0;
            cubes.forEach(c => {
                if (currentTakenNames.includes(c.name)) {
                    c.active = false;
                    c.el.style.display = 'none'; 
                    removedCount++;
                }
            });

            const validCandidates = cubes.filter(c => c.active);
            if (validCandidates.length === 0) {
                alert("–£—É—á–ª–∞–∞—Ä–∞–π, –¥—ç–ª–≥—ç—Ü—ç–Ω –¥—ç—ç—Ä—Ö —Ö“Ø–º“Ø“Ø—Å —Å–∞—è —Å—É–≥–∞–ª–∞–≥–¥—á–∏—Ö–ª–∞–∞! –î–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–Ω–æ —É—É.");
                setupSceneForUser(currentUser); 
                return;
            }

            isRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('changeUserBtn').disabled = true;

            const grid = document.getElementById('grid');
            const isMobile = window.innerWidth < 600;
            
            const activeCubes = cubes.filter(c => c.active);
            const count = activeCubes.length;
            const radius = isMobile ? Math.min(window.innerWidth/2 - 20, 200) : Math.max(300, (count * 25) / (2 * Math.PI) * 4); 

            activeCubes.forEach((c, i) => {
                const angle = (Math.PI * 2 / count) * i;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;
                
                c.el.style.transition = "transform 1.5s cubic-bezier(0.19, 1, 0.22, 1)";
                c.el.style.transform = `translate3d(${x}px, 0, ${z}px) rotateY(${-angle - Math.PI/2}rad)`;
            });

            setTimeout(() => {
                grid.style.animation = "spin 15s infinite linear";
            }, 1000);

            // Pick winner only from ACTIVE cubes
            const winnerIndex = Math.floor(Math.random() * activeCubes.length);
            const winner = activeCubes[winnerIndex];

            const eliminationSpeed = count > 30 ? 100 : 300; 

            const eliminationInterval = setInterval(() => {
                // Filter only currently active candidates (exclude winner)
                const candidates = cubes.filter(c => c.active && c.name !== winner.name);

                if (candidates.length === 0) {
                    clearInterval(eliminationInterval);
                    finalizeWinner(winner);
                    return;
                }

                const victimIndex = Math.floor(Math.random() * candidates.length);
                const victim = candidates[victimIndex];
                
                victim.active = false;
                victim.el.classList.add('is-eliminated');

            }, eliminationSpeed);
        }

        async function finalizeWinner(winner) {
            const grid = document.getElementById('grid');
            grid.style.animation = "none";
            const computedStyle = window.getComputedStyle(grid);
            const transform = computedStyle.getPropertyValue('transform');
            grid.style.transform = transform;
            
            winner.el.classList.add('is-selected');
            winner.el.style.transition = "all 1.5s cubic-bezier(0.34, 1.56, 0.64, 1)";
            winner.el.style.transform = winner.el.style.transform + " scale(2)";
            
            // --- SAVE TO FIREBASE ---
            try {
                if(!authUser) throw new Error("Not authenticated");

                await setDoc(doc(db, COLLECTION_NAME, currentUser), {
                    target: winner.name,
                    timestamp: new Date().toISOString()
                });
                console.log("Saved to DB");
            } catch(e) {
                console.error("Save error:", e);
                alert("–î–∞—Ç–∞ —Ö–∞–¥–≥–∞–ª–∞—Ö–∞–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞. –ì—ç—Ö–¥—ç—ç —Ç–∞–Ω—ã —Å—É–≥–∞–ª—Å–∞–Ω —Ö“Ø–Ω: " + winner.name);
            }

            setTimeout(() => {
                document.getElementById('resultNameDisplay').innerText = winner.name;
                document.getElementById('resultModal').classList.add('show');
                isRunning = false;
            }, 1500);
        }

        window.closeResult = function() {
            document.getElementById('resultModal').classList.remove('show');
            document.getElementById('changeUserBtn').disabled = false;
            showLogin();
        }

        // ================= SNOW FX =================
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');
        let width = window.innerWidth;
        let height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        const snowflakes = [];

        class Snowflake {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.v = Math.random() + 0.5;
                this.r = Math.random() * 2 + 1;
                this.o = Math.random();
            }
            update() {
                this.y += this.v;
                if (this.y > height) { this.y = -10; this.x = Math.random() * width; }
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255,255,255,${this.o})`;
                ctx.fill();
            }
        }

        function initSnow() {
            for(let i=0; i<80; i++) snowflakes.push(new Snowflake());
        }
        function animateSnow() {
            ctx.clearRect(0,0,width,height);
            snowflakes.forEach(s => { s.update(); s.draw(); });
            requestAnimationFrame(animateSnow);
        }
        window.onresize = () => {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
        }

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `
            @keyframes spin {
                0% { transform: rotateY(0deg); }
                100% { transform: rotateY(360deg); }
            }
        `;
        document.head.appendChild(styleSheet);
    </script>
</body>
</html>